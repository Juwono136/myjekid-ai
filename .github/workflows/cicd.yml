name: MyJekID CI/CD

on:
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"
  pull_request:
    branches:
      - master
    paths-ignore:
      - "README.md"

jobs:
  continuous-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push Backend Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/myjek-api:latest ./server
          docker push ${{ secrets.DOCKER_USERNAME }}/myjek-api:latest

      - name: Build and Push Frontend Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/myjek-frontend:latest ./client
          docker push ${{ secrets.DOCKER_USERNAME }}/myjek-frontend:latest

  continuous-deployment:
    needs: continuous-integration
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Pull Latest Backend Image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/myjek-api:latest

      - name: Pull Latest Frontend Image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/myjek-frontend:latest

      - name: Stop and Remove Old Containers
        run: |
          docker compose down || true

      - name: Run New Containers
        run: |
          docker compose up -d --remove-orphans
        env:
          # SERVER CONFIG
          PORT: ${{ secrets.PORT }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

          # EMAIL CONFIG
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}

          # DATABASE CONFIG
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

          # WAHA CONFIG
          WAHA_API_URL: ${{ secrets.WAHA_API_URL }}
          WAHA_API_KEY: ${{ secrets.WAHA_API_KEY }}

          # MINIO CONFIGURATION
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_PORT: ${{ secrets.S3_PORT }}
          S3_USE_SSL: ${{ secrets.S3_USE_SSL }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          BASE_IMAGE_URL: ${{ secrets.BASE_IMAGE_URL }}

          # REDIS CONFIG
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

          # AI CONFIGURATION
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}

          # API KEYS FOR AI MODELS
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # OLLAMA CONFIG (Local)
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
          OLLAMA_MODEL: ${{ secrets.OLLAMA_MODEL }}

          # LMSTUDIO CONFIG (Local)
          LMSTUDIO_BASE_URL: ${{ secrets.LMSTUDIO_BASE_URL }}
          LMSTUDIO_MODEL: ${{ secrets.LMSTUDIO_MODEL }}
          LMSTUDIO_API_KEY: ${{ secrets.LMSTUDIO_API_KEY }}
      - name: Add Containers to Tunnel
        run: |
          docker network connect ${{ secrets.TUNNEL_NAME }} myjek-api || true
          docker network connect ${{ secrets.TUNNEL_NAME }} myjek-frontend || true
